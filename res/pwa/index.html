<!doctype html>
<html lang="{{lang}}">
<head>
  <meta charset="{{charset}}">
  {{#base_href}}<base href="{{base_href}}">{{/base_href}}
  {{#title}}<title>{{title}}</title>{{/title}}
  {{#title}}<meta name="apple-mobile-web-app-title" content="{{title}}">{{/title}}
  {{#title}}<meta name="application-name" content="{{title}}">{{/title}}
  {{#description}}<meta name="description" content="{{description}}">{{/description}}
  {{#description}}<meta name="msapplication-tooltip" content="{{description}}">{{/description}}
  {{#keywords}}<meta name="keywords" content="{{keywords}}">{{/keywords}}
  {{#manifest}}<link rel="manifest" href="{{manifest}}">{{/manifest}}
  {{#theme_color}}<meta name="theme-color" content="{{theme_color}}">{{/theme_color}}
  {{#theme_color}}<meta name="msapplication-navbutton-color" content="{{theme_color}}">{{/theme_color}}
  {{#theme_color}}<meta name="msapplication-TileColor" content="{{theme_color}}">{{/theme_color}}
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  {{#ios_icon}}<link rel="apple-touch-icon" href="{{ios_icon}}">{{/ios_icon}}
  {{^ios_icon}}{{#icon}}<link rel="apple-touch-icon" href="{{icon}}">{{/icon}}{{/ios_icon}}
  {{#ms_icon}}<meta name="msapplication-TileImage" content="{{ms_icon}}">{{/ms_icon}}
  {{#favicon_ico}}<link rel="icon" href="{{favicon_ico}}" sizes="any">{{/favicon_ico}}
  {{^favicon_ico}}{{#favicon}}<link rel="icon" href="{{favicon}}" sizes="any">{{/favicon}}{{/favicon_ico}}
  {{#favicon_svg}}<link rel="icon" href="{{favicon_svg}}" type="image/svg+xml">{{/favicon_svg}}
  {{#splash_icon}}
  <script>
    (function() {
      var icon = '{{splash_icon}}';
      var bgLight = '{{splash_background}}' || '{{background_color}}' || '#ffffff';
      var bgDark = '{{splash_background_dark}}' || '{{theme_color}}' || '#000000';
      var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      var bg = isDark ? bgDark : bgLight;
      var dpr = window.devicePixelRatio || 1;
      var w = screen.width, h = screen.height;
      var pw = Math.round(w * dpr), ph = Math.round(h * dpr);
      function gen(pw, ph, orientation) {
        var canvas = document.createElement('canvas');
        canvas.width = pw;
        canvas.height = ph;
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, pw, ph);
        var img = new Image();
        img.onload = function() {
          var iconSize = Math.min(pw, ph) * 0.3;
          var x = (pw - iconSize) / 2, y = (ph - iconSize) / 2;
          ctx.drawImage(img, x, y, iconSize, iconSize);
          var link = document.createElement('link');
          link.rel = 'apple-touch-startup-image';
          link.media = '(device-width: ' + w + 'px) and (device-height: ' + h + 'px) and (-webkit-device-pixel-ratio: ' + dpr + ') and (orientation: ' + orientation + ')';
          link.href = canvas.toDataURL('image/png');
          document.head.appendChild(link);
        };
        img.src = icon;
      }
      gen(pw, ph, 'portrait');
      gen(ph, pw, 'landscape');
    })();
  </script>
  {{/splash_icon}}
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover,interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-starturl" content="">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="full-screen" content="yes">
  <meta name="browsermode" content="application">
  <meta name="nightmode" content="enable">
  <meta name="layoutmode" content="fitscreen">
  <meta name="imagemode" content="force">
  {{{head}}}
  {{#sw}}
  {{#initial}}
  <script defer>
    (function() {
      var swPath = '{{sw}}';
      var swReadyFired = false;
      function swReady() {
        if (swReadyFired) return;
        swReadyFired = true;
        if (document.body) {
          document.body.classList.add('sw-ready');
          document.body.dispatchEvent(new CustomEvent('sw-ready'));
        }
      }
      function swError() {
        if (document.body) {
          document.body.classList.add('sw-error');
          document.body.dispatchEvent(new CustomEvent('sw-error'));
        }
      }
      function onReady() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swReady);
        } else {
          swReady();
        }
      }
      function signalPageReady(worker) {
        if (!worker) return;
        function doSignal() {
          worker.postMessage({ type: 'page_resources_loaded' });
        }
        if (document.readyState === 'complete') {
          doSignal();
        } else {
          window.addEventListener('load', doSignal, { once: true });
        }
      }
      function handleControllerChange() {
        {{#update_redirect_delay}}
        if (document.body && document.body.classList.contains('sw-update')) {
          document.body.classList.remove('sw-update');
          setTimeout(function() {
            window.location.replace({{#update_redirect}}'{{update_redirect}}'{{/update_redirect}}{{^update_redirect}}window.location.href{{/update_redirect}});
          }, {{update_redirect_delay}});
          return;
        }
        {{/update_redirect_delay}}
        window.location.replace({{#update_redirect}}'{{update_redirect}}'{{/update_redirect}}{{^update_redirect}}window.location.href{{/update_redirect}});
      }
      if (!('serviceWorker' in navigator)) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swError);
        } else {
          swError();
        }
        return;
      }
      navigator.serviceWorker.addEventListener('controllerchange', handleControllerChange, { once: true });
      navigator.serviceWorker.register(swPath).then(function(reg) {
        window.swRegistration = reg;
        if (reg.active && !navigator.serviceWorker.controller) {
          window.location.replace(window.location.href);
          return;
        }
        if (navigator.serviceWorker.controller) {
          onReady();
          return;
        }
        signalPageReady(reg.installing || reg.waiting);
        function waitForActive(worker) {
          if (!worker) return;
          if (worker.state === 'activated') {
            if (navigator.serviceWorker.controller) {
              onReady();
            }
            return;
          }
          worker.addEventListener('statechange', function() {
            if (worker.state === 'activated' && navigator.serviceWorker.controller) {
              onReady();
            }
          });
        }
        if (reg.installing) {
          waitForActive(reg.installing);
        } else if (reg.waiting) {
          waitForActive(reg.waiting);
        } else if (reg.active) {
          waitForActive(reg.active);
        }
        reg.addEventListener('updatefound', function() {
          var newWorker = reg.installing;
          waitForActive(newWorker);
          newWorker.addEventListener('statechange', function() {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller && document.body) {
              document.body.classList.add('sw-update');
            }
          });
        });
      }).catch(function() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swError);
        } else {
          swError();
        }
      });
    })();
  </script>
  {{/initial}}
  {{^initial}}
  <script defer>
    (function() {
      {{#verbose}}var log = function() { console.log.apply(console, ['[SW-Page]'].concat(Array.prototype.slice.call(arguments))); };{{/verbose}}
      {{^verbose}}var log = function() {};{{/verbose}}
      var swTarget = null;
      function getSwTarget() {
        if (!swTarget) swTarget = {{#sw_target}}document.querySelector('{{sw_target}}') || {{/sw_target}}document.body;
        return swTarget;
      }
      function swReady() {
        var t = getSwTarget();
        log('swReady called');
        if (t) {
          t.classList.add('sw-ready');
          t.dispatchEvent(new CustomEvent('sw-ready'));
        }
      }
      function swError() {
        var t = getSwTarget();
        log('swError called');
        if (t) {
          t.classList.add('sw-error');
          t.dispatchEvent(new CustomEvent('sw-error'));
        }
      }
      function handleControllerChange() {
        log('controllerchange event');
        var t = getSwTarget();
        {{#update_redirect_delay}}
        if (t && t.classList.contains('sw-update')) {
          t.classList.remove('sw-update');
          setTimeout(function() {
            window.location.replace({{#update_redirect}}'{{update_redirect}}'{{/update_redirect}}{{^update_redirect}}window.location.href{{/update_redirect}});
          }, {{update_redirect_delay}});
          return;
        }
        {{/update_redirect_delay}}
        window.location.replace({{#update_redirect}}'{{update_redirect}}'{{/update_redirect}}{{^update_redirect}}window.location.href{{/update_redirect}});
      }
      if (!navigator.serviceWorker) {
        log('No serviceWorker support');
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swError);
        } else {
          swError();
        }
        return;
      }
      navigator.serviceWorker.addEventListener('controllerchange', handleControllerChange, { once: true });
      if (navigator.serviceWorker.controller) {
        log('Controller exists');
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swReady);
        } else {
          swReady();
        }
      } else {
        log('No controller, waiting for ready');
      }
      navigator.serviceWorker.ready.then(function(reg) {
        log('SW ready');
        window.swRegistration = reg;
        if (!navigator.serviceWorker.controller) {
          log('Still no controller after ready, waiting for controllerchange');
        }
        navigator.serviceWorker.addEventListener('message', function(event) {
          var t = getSwTarget();
          log('SW message:', event.data && event.data.type);
          if (event.data && event.data.type === 'version_mismatch' && t) {
            t.classList.add('sw-update');
            t.classList.add('sw-blocking');
          }
          if (event.data && event.data.type === 'sw-broadcast' && t) {
            t.dispatchEvent(new CustomEvent(event.data.name, { detail: event.data.data, bubbles: true }));
          }
        });
        var t = getSwTarget();
        if (reg.waiting && navigator.serviceWorker.controller && t) {
          t.classList.add('sw-update');
          log('Waiting worker found');
        }
        reg.addEventListener('updatefound', function() {
          log('updatefound event');
          var newWorker = reg.installing;
          newWorker.addEventListener('statechange', function() {
            var t = getSwTarget();
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller && t) {
              t.classList.add('sw-update');
              log('New worker installed');
            }
          });
        });
      });
    })();
  </script>
  {{/initial}}
  {{/sw}}
</head>
{{#body}}{{{body}}}{{/body}}
{{^body}}<body {{{body_attrs}}}>{{{body_content}}}</body>{{/body}}
</html>
