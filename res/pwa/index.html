<!doctype html>
<html lang="{{lang}}">
<head>
  <meta charset="{{charset}}">
  {{#base_href}}<base href="{{base_href}}">{{/base_href}}
  {{#title}}<title>{{title}}</title>{{/title}}
  {{#title}}<meta name="apple-mobile-web-app-title" content="{{title}}">{{/title}}
  {{#title}}<meta name="application-name" content="{{title}}">{{/title}}
  {{#description}}<meta name="description" content="{{description}}">{{/description}}
  {{#description}}<meta name="msapplication-tooltip" content="{{description}}">{{/description}}
  {{#keywords}}<meta name="keywords" content="{{keywords}}">{{/keywords}}
  {{#manifest}}<link rel="manifest" href="{{manifest}}">{{/manifest}}
  {{#theme_color}}<meta name="theme-color" content="{{theme_color}}">{{/theme_color}}
  {{#theme_color}}<meta name="msapplication-navbutton-color" content="{{theme_color}}">{{/theme_color}}
  {{#theme_color}}<meta name="msapplication-TileColor" content="{{theme_color}}">{{/theme_color}}
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  {{#ios_icon}}<link rel="apple-touch-icon" href="{{ios_icon}}">{{/ios_icon}}
  {{^ios_icon}}{{#icon}}<link rel="apple-touch-icon" href="{{icon}}">{{/icon}}{{/ios_icon}}
  {{#ms_icon}}<meta name="msapplication-TileImage" content="{{ms_icon}}">{{/ms_icon}}
  {{#favicon_ico}}<link rel="icon" href="{{favicon_ico}}" sizes="any">{{/favicon_ico}}
  {{^favicon_ico}}{{#favicon}}<link rel="icon" href="{{favicon}}" sizes="any">{{/favicon}}{{/favicon_ico}}
  {{#favicon_svg}}<link rel="icon" href="{{favicon_svg}}" type="image/svg+xml">{{/favicon_svg}}
  {{#splash_screens}}
  <link rel="apple-touch-startup-image" media="(device-width: {{width}}px) and (device-height: {{height}}px) and (-webkit-device-pixel-ratio: {{dpr}})" href="{{src}}">
  {{/splash_screens}}
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,interactive-widget=resizes-content">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-starturl" content="">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="full-screen" content="yes">
  <meta name="browsermode" content="application">
  <meta name="nightmode" content="enable">
  <meta name="layoutmode" content="fitscreen">
  <meta name="imagemode" content="force">
  {{{head}}}
  {{#sw}}
  {{#initial}}
  <script defer>
    (function() {
      var swPath = '{{sw}}';
      var swReadyFired = false;
      function swReady() {
        if (swReadyFired) return;
        swReadyFired = true;
        if (document.body) {
          document.body.classList.add('sw-ready');
          document.body.dispatchEvent(new CustomEvent('sw-ready'));
        }
      }
      function swError() {
        if (document.body) {
          document.body.classList.add('sw-error');
          document.body.dispatchEvent(new CustomEvent('sw-error'));
        }
      }
      function onReady() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swReady);
        } else {
          swReady();
        }
      }
      function signalPageReady(worker) {
        if (!worker) return;
        function doSignal() {
          worker.postMessage({ type: 'page_resources_loaded' });
        }
        if (document.readyState === 'complete') {
          doSignal();
        } else {
          window.addEventListener('load', doSignal, { once: true });
        }
      }
      if (!('serviceWorker' in navigator)) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swError);
        } else {
          swError();
        }
        return;
      }
      navigator.serviceWorker.register(swPath).then(function(reg) {
        window.swRegistration = reg;
        if (reg.active && !navigator.serviceWorker.controller) {
          window.location.replace(window.location.href);
          return;
        }
        if (navigator.serviceWorker.controller) {
          onReady();
          navigator.serviceWorker.addEventListener('controllerchange', function() {
            window.location.replace(window.location.href);
          }, { once: true });
          return;
        }
        navigator.serviceWorker.addEventListener('controllerchange', function() {
          window.location.replace(window.location.href);
        }, { once: true });
        signalPageReady(reg.installing || reg.waiting);
        function waitForActive(worker) {
          if (!worker) return;
          if (worker.state === 'activated') {
            if (navigator.serviceWorker.controller) {
              onReady();
            }
            return;
          }
          worker.addEventListener('statechange', function() {
            if (worker.state === 'activated' && navigator.serviceWorker.controller) {
              onReady();
            }
          });
        }
        if (reg.installing) {
          waitForActive(reg.installing);
        } else if (reg.waiting) {
          waitForActive(reg.waiting);
        } else if (reg.active) {
          waitForActive(reg.active);
        }
        reg.addEventListener('updatefound', function() {
          var newWorker = reg.installing;
          waitForActive(newWorker);
          newWorker.addEventListener('statechange', function() {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller && document.body) {
              document.body.classList.add('sw-update');
            }
          });
        });
      }).catch(function() {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swError);
        } else {
          swError();
        }
      });
    })();
  </script>
  {{/initial}}
  {{^initial}}
  <script defer>
    (function() {
      {{#verbose}}var log = function() { console.log.apply(console, ['[SW-Page]'].concat(Array.prototype.slice.call(arguments))); };{{/verbose}}
      {{^verbose}}var log = function() {};{{/verbose}}
      var swTarget = {{#sw_target}}document.querySelector('{{sw_target}}') || {{/sw_target}}document.body;
      log('swTarget:', swTarget);
      function swReady() {
        log('swReady called, swTarget:', swTarget);
        if (swTarget) {
          swTarget.classList.add('sw-ready');
          swTarget.dispatchEvent(new CustomEvent('sw-ready'));
          log('Added sw-ready class');
        }
      }
      function swError() {
        log('swError called');
        if (swTarget) {
          swTarget.classList.add('sw-error');
          swTarget.dispatchEvent(new CustomEvent('sw-error'));
          log('Added sw-error class');
        }
      }
      function onReady() {
        log('onReady called, readyState:', document.readyState);
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swReady);
        } else {
          swReady();
        }
      }
      log('navigator.serviceWorker:', !!navigator.serviceWorker, 'controller:', !!navigator.serviceWorker?.controller);
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        log('Controller exists, calling onReady');
        onReady();
        navigator.serviceWorker.addEventListener('controllerchange', function() {
          log('controllerchange event, reloading');
          window.location.replace(window.location.href);
        }, { once: true });
      } else if (navigator.serviceWorker) {
        log('No controller, waiting for controllerchange');
        var timeout = setTimeout(function() {
          log('Timeout reached, calling swError');
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', swError);
          } else {
            swError();
          }
        }, 10000);
        navigator.serviceWorker.addEventListener('controllerchange', function() {
          log('controllerchange event, clearing timeout and reloading');
          clearTimeout(timeout);
          window.location.replace(window.location.href);
        }, { once: true });
      } else {
        log('No serviceWorker support, calling swError');
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', swError);
        } else {
          swError();
        }
      }
      if (navigator.serviceWorker) {
        log('Setting up ready.then');
        navigator.serviceWorker.ready.then(function(reg) {
          log('SW ready, reg:', reg);
          window.swRegistration = reg;
          navigator.serviceWorker.addEventListener('message', function(event) {
            log('SW message:', event.data);
            if (event.data && event.data.type === 'version_mismatch' && swTarget) {
              swTarget.classList.add('sw-update');
              swTarget.classList.add('sw-blocking');
              log('Added sw-update and sw-blocking classes');
            }
            if (event.data && event.data.type === 'sw-broadcast' && swTarget) {
              log('Dispatching sw-broadcast event:', event.data.name);
              swTarget.dispatchEvent(new CustomEvent(event.data.name, { detail: event.data.data, bubbles: true }));
            }
          });
          log('reg.waiting:', reg.waiting, 'controller:', !!navigator.serviceWorker.controller);
          if (reg.waiting && navigator.serviceWorker.controller && swTarget) {
            swTarget.classList.add('sw-update');
            log('Added sw-update class (waiting worker)');
          }
          reg.addEventListener('updatefound', function() {
            log('updatefound event');
            var newWorker = reg.installing;
            newWorker.addEventListener('statechange', function() {
              log('Worker statechange:', newWorker.state);
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller && swTarget) {
                swTarget.classList.add('sw-update');
                log('Added sw-update class (installed worker)');
              }
            });
          });
        });
      }
    })();
  </script>
  {{/initial}}
  {{/sw}}
</head>
{{#body}}{{{body}}}{{/body}}
{{^body}}<body {{{body_attrs}}}>{{{body_content}}}</body>{{/body}}
</html>
